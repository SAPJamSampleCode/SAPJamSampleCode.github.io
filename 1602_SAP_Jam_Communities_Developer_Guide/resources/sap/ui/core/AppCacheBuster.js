/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2014 SAP SE or an SAP affiliate company. 
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','./Core','sap/ui/thirdparty/URI'],function(q,C,U){"use strict";var c=sap.ui.getCore().getConfiguration();var l=c.getLanguage();var s=c.getAppCacheBusterMode()==="sync";var b=c.getAppCacheBusterMode()==="batch";var i={};var a=q.ajax;var I=q.sap.includeScript;var f=q.sap.includeStyleSheet;var v=sap.ui.base.ManagedObject.prototype.validateProperty;var L=document.location.href.replace(/\?.*|#.*/g,"");var B=URI("./").absoluteTo(L);var A=B.toString();var u=URI(q.sap.getModulePath("","/../"));var o=u.toString();if(u.is("relative")){u=u.absoluteTo(L)}var d=u.normalize().toString();var r=URI("resources").absoluteTo(d).toString();var F=new RegExp("^"+q.sap.escapeRegExp(r));var E=function(e){if(e.length>0&&e.slice(-1)!=="/"){e+="/"}return e};var R=function(d,S){var e;if(q.isArray(d)&&!b){q.each(d,function(x,y){R(y,S)})}else if(q.isArray(d)&&b){var h=E(d[0]);var j=[];q.sap.log.debug("sap.ui.core.AppCacheBuster.register(\""+h+"\"); // BATCH MODE!");var k=g.normalizeURL(h);q.sap.log.debug("  --> normalized to: \""+k+"\"");q.each(d,function(x,y){var m=E(y);var z=g.normalizeURL(m);if(!i[n]){j.push(z)}});if(j.length>0){var m=k+"sap-ui-cachebuster-info.json?sap-ui-language="+l;e={url:m,type:"POST",async:!s&&!!S,dataType:"json",contentType:"text/plain",data:j.join("\n"),success:function(x){q.extend(i,x)},error:function(){q.sap.log.error("Failed to batch load AppCacheBuster index file from: \""+m+"\".")}}}}else{d=E(d);q.sap.log.debug("sap.ui.core.AppCacheBuster.register(\""+d+"\");");var n=g.normalizeURL(d);q.sap.log.debug("  --> normalized to: \""+n+"\"");if(!i[n]){var m=n+"sap-ui-cachebuster-info.json?sap-ui-language="+l;e={url:m,async:!s&&!!S,dataType:"json",success:function(x){i[n]=x},error:function(){q.sap.log.error("Failed to load AppCacheBuster index file from: \""+m+"\".")}}}}if(e){if(e.async){var p=S.startTask("load "+m);var t=e.success,w=e.error;q.extend(e,{success:function(x){t.apply(this,arguments);S.finishTask(p)},error:function(){w.apply(this,arguments);S.finishTask(p,false)}})}q.sap.log.info("Loading AppCacheBuster index file from: \""+m+"\".");q.ajax(e)}};var g={boot:function(S){var e=c.getAppCacheBuster();if(e&&e.length>0){e=e.slice();var h=true;var V=String(e[0]).toLowerCase();if(e.length===1){if(V==="true"||V==="x"){var u=URI(o);e=u.is("relative")?[u.toString()]:[]}else if(V==="false"){h=false}}if(h){g.init();R(e,S)}}},init:function(){var h=g.convertURL;var n=g.normalizeURL;var j=function(e){if(e&&typeof(e)==="string"){e=n(e);return!e.match(F)}return false};q.ajax=function(e,k){if(e&&e.url&&j(e.url)){e.url=h(e.url)}return a.apply(this,arguments)};q.sap.includeScript=function(e,k){var m=Array.prototype.slice.apply(arguments);if(j(m[0])){m[0]=h(m[0])}return I.apply(this,m)};q.sap.includeStyleSheet=function(e,k){var m=Array.prototype.slice.apply(arguments);if(j(m[0])){m[0]=h(m[0])}return f.apply(this,m)};sap.ui.base.ManagedObject.prototype.validateProperty=function(p,V){var m=this.getMetadata(),P=m.getAllProperties()[p],k;if(P&&P.type==="sap.ui.core.URI"){k=Array.prototype.slice.apply(arguments);try{if(j(k[1])){k[1]=h(k[1])}}catch(e){}}return v.apply(this,k||arguments)}},exit:function(){q.ajax=a;q.sap.includeScript=I;q.sap.includeStyleSheet=f;sap.ui.base.ManagedObject.prototype.validateProperty=v;i={}},register:function(d){R(d)},convertURL:function(e){q.sap.log.debug("sap.ui.core.AppCacheBuster.convertURL(\""+e+"\");");if(i&&e){var n=g.normalizeURL(e);q.sap.log.debug("  --> normalized to: \""+n+"\"");if(n&&g.handleURL(n)){q.each(i,function(d,m){var h;if(d&&n.length>=d.length&&n.slice(0,d.length)===d){h=n.slice(d.length);if(m[h]){e=d+"~"+m[h]+"~/"+h;q.sap.log.debug("  ==> return \""+e+"\";");return false}}})}}return e},normalizeURL:function(e){var u=URI(e||"./");if(u.is("relative")){u=u.absoluteTo(L)}return u.normalizeProtocol().normalizeHostname().normalizePort().normalizePath().toString()},handleURL:function(e){return true}};return g},true);
